extends ../../layout/default.pug
include ../../mixins/modal.pug

block main 

  link(rel="stylesheet", href="/css/admin/products/modal.css")

  if (role.permissions.includes("product_view"))

    - if (messages.successPosition)
      div(
        class="notifications" 
        data-status="success" 
        data-mess= messages.successPosition[0]
      )

    - if (messages.successStatus)
      div(
        class="notifications" 
        data-status="success" 
        data-mess= messages.successStatus[0]
      )

    - if (messages.successDelete)
      div(
        class="notifications" 
        data-status="warning" 
        data-mess=messages.successDelete[0]
      )

    - if (message.successEdit.length > 0)
      div(
        class="notifications" 
        data-status="success" 
        data-mess=message.successEdit[0]
      )

    - if (message.successCreate)
      div(
        class="notifications" 
        data-status="success" 
        data-mess=message.successCreate[0]
      )
      

    //- - if (messages.successPosition)
    //-   span= messages.successPosition

    h1.title Products


    .container-fluid.pt-2
      // FILTER START
      .card.shadow-css.p-3.mb-5
        form(action='' form-filter)
          .card-body
            h2.card-title.pb-3 Filter
            .row
              .col-3
                label.form-label(for='filter-name') Filter name: 
                input.form-control(type='text' placeholder="Input name ..." id="filter-name")
              .col-3
                label.form-label(for='filter-active') Filter active: 
                select.form-select(name='' id='filter-active')
                  option(value="") All
                  option(value="active") Active 
                  option(value="inactive") Inactive   
              .col-3
                label.form-label(for='filter-featured') Filter featured: 
                select.form-select(name='' id='filter-featured')
                  option(value="") All
                  option(value="true") True 
                  option(value="false") False   
              .col-3
                label.form-label(for='filter-sort') Filter sort: 
                select.form-select(name='' id='filter-sort')
                  option(value="") Sort 
                  option(value="position-desc") Vị trí giảm dần  
                  option(value="position-asc") Vị trí tăng dần
                  option(value="price-desc") Giá giảm dần
                  option(value="price-asc") Giá tăng dần
            .row.mt-2
              .col-3
                button.btn.btn-primary(type="submit" btn-filter)
                  <i class="fa-solid fa-filter mr-1" style="border: none"></i> Filter
      // FILTER END
      // LIST PRODUCTS START
      .card.shadow-css.p-3.mb-5
        .card-body
          h2.card-title.pb-3 List Prodcuts
          if (role.permissions.includes('product_edit'))
            .row
              .col-6
                .input-group
                  input.form-control(type='file')
                  button.btn.btn-success  + Import
                  button.btn.btn-secondary  - Export
              .col-1
              .col-4
                if (role.permissions.includes('product_edit'))
                  form(
                    action=`${prefixAdmin}/products/change-multi?_method=PATCH`
                    method="POST"
                    form-change-multi
                  )
                    .input-group
                      select.form-select(name='type' id='')
                        option(disable selected) Choose active
                        option(value="active") Active 
                        option(value="inactive") Inactive 
                        option(value="featured-true") Featured true
                        option(value="featured-false") Featured false
                        if (role.permissions.includes('product_delete'))
                          option(value="delete") Delete
                        option(value="position") Sort position 
                      input(
                        type="text"
                        name="ids"
                        value=""
                        class="form-control"
                        class="d-none"
                      )
                      button.btn.btn-primary(type="submit") Apply Action 
              .col-1
                if (role.permissions.includes('product_create'))
                  a.btn.btn-primary(href=`${prefixAdmin}/products/create`)  + New
          .row.p-2.mt-3
            table.table-css.mb-5(checkbox-multi)
              thead
                tr
                  if (role.permissions.includes('product_edit'))
                    td 
                      input(type="checkbox" name="checkall")
                  td(scope='col') #
                  td(scope='col') Image
                  td(scope='col') Title
                  td(scope="col") Category
                  td(scope='col') Price (VND)
                  td(scope='col') Position
                  td(scope='col') Featured
                  td(scope='col') Status
                  td(scope='col') Action
              tbody
                each item, index in products 
                  tr 
                    if (role.permissions.includes('product_edit'))
                      td 
                        input(type="checkbox" name="id" value=item.id)
                    th(scope='row' style="padding: 0px 20px") #{index + 1}
                    td 
                      img(src=item.media[0].url alt=item.media[0].alt width='100px' class="img-thumbnail")
                    td=item.title
                    td 
                      if item.category 
                        | #{item.category.title}
                      else 
                        | No Category
                    td #{item.price}VND
                    if (role.permissions.includes('product_edit'))              
                      td 
                        form(
                          action="" 
                          form-change-position
                          method="POST"
                          data-path=`${prefixAdmin}/products/change-position`
                        )
                          input(
                            change-position
                            type="text"
                            min="1"
                            name="position"
                            value=item.position 
                            idItem=item._id
                            class="form-control"
                            style="width: 50px; text-align: center"
                          ) 
                    else 
                      td.text-center=item.position
                    if (role.permissions.includes('product_edit'))
                      td 
                        if(item.featured == true)
                          a(
                            href="javascript:;" 
                            btn-change-featured
                            itemFeatured=item.featured
                            itemId=item._id
                            class='badge badge-success p-2'
                            style="font-size: 0.9rem"
                          ) True
                        else 
                          a(
                            href="javascript:;" 
                            btn-change-featured
                            itemFeatured=item.featured
                            itemId=item._id
                            class='badge badge-danger p-2'
                            style="font-size: 0.9rem"
                          ) False
                    else  
                      td 
                        if (item.featured == true)
                          p.text-success True
                        else 
                          p.text-danger False
                    if (role.permissions.includes('product_edit'))
                      td 
                        if(item.status == "active")
                          a(
                            href="javascript:;" 
                            btn-change-status
                            itemStatus=item.status 
                            itemId=item.id
                            class='badge badge-success p-2'
                            style="font-size: 0.9rem"
                          ) Active
                        else 
                          a(
                            href="javascript:;" 
                            btn-change-status
                            itemStatus=item.status 
                            itemId=item._id
                            class='badge badge-danger p-2'
                            style="font-size: 0.9rem"
                          ) Inactive
                    else  
                      td 
                        if (item.status == "active")
                          p.text-success Active
                        else 
                          p.text-danger Inactive
                    td  
                      a(
                          href=`${prefixAdmin}/products/read/${item._id}`
                          class='btn btn-primary btn-sm p-2 m-2'
                          style="font-size: 0.9rem"
                          data-bs-toggle="tooltip" 
                          data-bs-placement="top" 
                          data-bs-offset="0,10"
                          data-bs-custom-class="custom-tooltip"
                          title="Read"
                      ) <i class="fa-brands fa-readme"></i>
                      if (role.permissions.includes('product_edit'))
                        a(
                          href=`${prefixAdmin}/products/edit/${item._id}`
                          class='btn btn-warning btn-sm p-2 m-2'
                          style="font-size: 0.9rem"
                          data-bs-toggle="tooltip" 
                          data-bs-placement="top" 
                          data-bs-offset="0,10"
                          data-bs-custom-class="custom-tooltip"
                          title="Edit"
                        ) <i class="fa-solid fa-pen-to-square"></i>
                        if (role.permissions.includes('product_delete'))
                          button(
                            class='btn btn-danger btn-sm p-2 m-2'
                            button-delete
                            data-id=item._id
                            style="font-size: 0.9rem"
                            data-bs-toggle="tooltip" 
                            data-bs-placement="top"
                            data-bs-offset="0,10"
                            data-bs-custom-class="custom-tooltip"
                            title="Delete"
                          ) <i class="fa-regular fa-trash"></i>
                      button(
                        class='btn btn-secondary btn-sm p-2 m-2'
                        style="font-size: 0.9rem"
                        data-bs-toggle="tooltip" 
                        data-bs-placement="top" 
                        data-bs-offset="0,10"
                        data-bs-custom-class="custom-tooltip"
                        title="Statistical"
                        btn-show-statistical
                        data-product=JSON.stringify(item)
                      ) <i class="fa-solid fa-chart-bar"></i>


          .row
            .col-10
              nav(aria-label='Page navigation example')
                ul.pagination
                  li.page-item
                    button.page-link(page-pagination=pagination.currentPage-1)
                      span(aria-hidden='true') &laquo;
                  - for(let i = 1; i <= pagination.totalPage; i ++) 
                    li(class=`page-item ${pagination.currentPage == i ? "active" : ""}`)
                      button.page-link(page-pagination=i) #{i}
                  li.page-item
                    button.page-link(page-pagination=pagination.currentPage+1)
                      span(aria-hidden='true') &raquo;
            .col
              form(
                action=""
                form-number-items-page
              )
                select.form-select(name='numberItemPage' select-number-items-page)
                  - for (let i = 4; i <= 10; i += 2)
                    option(value=i selected=(pagination.limitItem == i ? true : false)) #{i} items per page

    //- Modal để xem người tạo, người cập nhật và người xoá sản phẩm
    +modal()

    if (role.permissions.includes('product_edit'))
      form(
        action=""
        method="POST"
        id = 'form-change-status'
        data-path = `${prefixAdmin}/products/change-status`
      ) 

      form(
        action=""
        method="POST"
        id = 'form-change-featured'
        data-path = `${prefixAdmin}/products/change-featured`
      ) 

      form(
        action=""
        method="POST"
        id = 'form-delete'
        data-path = `${prefixAdmin}/products/delete-product`
      ) 
                
      // LIST PRODUCTS END
      script(src="/js/admin/filter.js")
      script(src="/js/admin/pagination.js")
      script(src="/js/admin/changePosition.js")
      script(src="/js/admin/changeStatus.js")
      script(src="/js/admin/deleteProduct.js")
      script(src="/js/admin/fontend/modal.js")
    else 
      h3.notFound Bạn không có quyền quản lý sản phẩm
